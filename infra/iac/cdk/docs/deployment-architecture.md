# デプロイメントアーキテクチャ

## CDKスタックの分割

CloudFrontとACM証明書の作成には、以下の順序での作業が必須となる。

1. Route 53ホストゾーンの作成
2. ドメインレジストラでのNSレコード設定
3. ACM証明書のDNS検証
4. CloudFrontディストリビューションの作成

この技術的な依存関係により、CDKスタックを以下の3つに分割している。

1. 共有インフラストラクチャ
   - Route 53ホストゾーンを作成する
   - NSレコードの値を取得する

2. シークレット値の設定
   - アプリケーション実行に必要な認証情報を準備する

3. アプリケーションパイプライン
   - ACM証明書の作成とDNS検証を行う
   - CloudFrontディストリビューションを作成する
   - アプリケーションリソースをデプロイする

## リージョン間の連携

CloudFrontの技術仕様により、以下の構成が必要となる。

1. CloudFront証明書（us-east-1）
   - ACM証明書はus-east-1でのみ作成可能
   - DNS検証にはRoute 53のホストゾーンが必要

2. アプリケーションリソース（ap-northeast-1）
   - Lambda、API Gateway等のリソースを配置
   - Route 53のホストゾーンを管理

3. リージョン間の値の共有
   - SSMパラメータストアでホストゾーンIDを共有
   - クロスリージョンリファレンスを有効化

## 環境の分離

同一AWSアカウント内で開発環境と本番環境を分離する。

1. ドメイン名
   - 開発環境: dev.{baseDomainName}
   - 本番環境: {baseDomainName}

2. デプロイパイプライン
   - 開発環境: developブランチから自動デプロイ
   - 本番環境: mainブランチから承認後にデプロイ

3. シークレット値
   - 環境別にSecrets Managerリソースを作成
   - 認証情報を環境ごとに管理

## 運用時の注意点

1. DNS設定
   - NSレコードの設定は慎重に行う
   - 誤った変更はシステム全体に影響を与える

2. 証明書管理
   - ACM証明書は自動更新される
   - 更新失敗時はDNS検証の状態を確認する

3. デプロイ管理
   - 開発環境は迅速なフィードバックを重視
   - 本番環境は変更内容の確認を徹底する

詳細な手順は[開発環境デプロイ手順書](./deployment-guide-dev.md)を参照すること。
